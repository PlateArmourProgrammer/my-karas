{"version":3,"file":"index.js","sources":["src/index.js"],"sourcesContent":["import karas from 'karas';\nimport { version } from '../package.json';\n\nkaras.inject.requestAnimationFrame = function(cb) {\n  setTimeout(cb, 1000 / 60);\n};\n\nclass Root extends karas.Root {\n  appendTo(dom) {\n    if(karas.util.isFunction(dom.getContext)) {\n      this.__dom = dom;\n      this.__ctx = dom.getContext('2d');\n    }\n    else {\n      this.__dom = {};\n      this.__ctx = dom;\n    }\n    this.__children = karas.builder.initRoot(this.__cd, this);\n    this.__initProps();\n    this.__root = this;\n    this.cache = !!this.props.cache;\n    this.__refreshLevel = karas.refresh.level.REFLOW;\n    this.__renderMode = karas.mode.CANVAS;\n    this.__defs = {\n      clear() {},\n    };\n    this.refresh(null, true);\n  }\n\n  refresh(cb, isFirst) {\n    let self = this;\n    let ctx = self.ctx;\n\n    function wrap() {\n      ctx.draw && ctx.draw(true);\n    }\n\n    super.refresh(wrap, isFirst);\n  }\n}\n\n// Root引用指过来\nlet createVd = karas.createVd;\nkaras.createVd = function(tagName, props, children) {\n  if(['canvas', 'svg'].indexOf(tagName) > -1) {\n    return new Root(tagName, props, children);\n  }\n  return createVd(tagName, props, children);\n};\n\nconst IMG = karas.inject.IMG;\nconst INIT = karas.inject.INIT;\nconst LOADING = karas.inject.LOADING;\nconst LOADED = karas.inject.LOADED;\n\nkaras.inject.measureImg = function(url, cb, optinos = {}) {\n  let { root, width = 0, height = 0 } = optinos;\n  let ctx = root.ctx;\n  if(url.indexOf('data:') === 0) {\n    let img = ctx.createImage();\n    img.onload = function() {\n      cb({\n        success: true,\n        width: width,\n        height: height,\n        url,\n        source: img,\n      });\n    };\n    img.src = url;\n    return;\n  }\n  let cache = IMG[url] = IMG[url] || {\n    state: INIT,\n    task: [],\n  };\n  if(cache.state === LOADED) {\n    cb(cache);\n  }\n  else if(cache.state === LOADING) {\n    cache.task.push(cb);\n  }\n  else {\n    cache.state = LOADING;\n    cache.task.push(cb);\n    my.getImageInfo({\n      src: url,\n      success: function(res) {\n        let createImage = ctx.createImage || ctx.canvas.createImage;\n        let img = createImage();\n        img.onload = function() {\n          cache.state = LOADED;\n          cache.success = true;\n          cache.width = res.width;\n          cache.height = res.height;\n          cache.source = img;\n          cache.url = url;\n          let list = cache.task.splice(0);\n          list.forEach(cb => cb(cache));\n        };\n        img.src = url;\n      },\n      fail: function() {\n        cache.state = LOADED;\n        cache.success = false;\n        cache.url = url;\n        let list = cache.task.splice(0);\n        list.forEach(cb => cb(cache));\n      },\n    });\n  }\n};\n\nkaras.inject.isDom = function(o) {\n  return o && karas.util.isFunction(o.arc);\n}\n\nconst CANVAS = {};\nconst CANVAS_LIST = [];\nconst WEBGL_LIST = [];\n\nfunction cache(key, width, height, hash, message) {\n  let o;\n  if(!key) {\n    let target = hash === CANVAS ? CANVAS_LIST : WEBGL_LIST;\n    if(target.length) {\n      o = target.pop();\n    }\n    else {\n      o = my._createOffscreenCanvas(width, height);\n    }\n  }\n  else if(!hash[key]) {\n    o = hash[key] = my._createOffscreenCanvas(width, height);\n  }\n  else {\n    o = hash[key];\n  }\n  o.width = width;\n  o.height = height;\n  return {\n    canvas: o,\n    ctx: hash === CANVAS ? o.getContext('2d')\n      : (o.getContext('webgl') || o.getContext('experimental-webgl')),\n    draw() {\n      // 空函数，仅对小程序提供hook特殊处理，flush缓冲\n    },\n    available: true,\n    release() {\n      if(hash === CANVAS) {\n        CANVAS_LIST.push(this.canvas);\n      }\n      else {\n        WEBGL_LIST.push(this.canvas);\n      }\n      this.canvas = null;\n      this.ctx = null;\n    },\n  };\n}\n\nfunction cacheCanvas(key, width, height, message) {\n  return cache(key, width, height, CANVAS, message);\n}\n\nkaras.inject.hasCacheCanvas = function(key) {\n  return key && CANVAS.hasOwnProperty(key);\n};\n\nkaras.inject.getCacheCanvas = function(width, height, key, message) {\n  return cacheCanvas(key, width, height, message);\n};\n\nkaras.inject.releaseCacheCanvas = function(o) {\n  CANVAS_LIST.push(o);\n};\n\nkaras.inject.delCacheCanvas = function(key) {\n  key && delete CANVAS[key];\n};\n\nkaras.myVersion = version;\n\nexport default karas;\n"],"names":["karas","inject","requestAnimationFrame","cb","setTimeout","Root","dom","util","isFunction","getContext","__dom","__ctx","__children","builder","initRoot","__cd","__initProps","__root","cache","props","__refreshLevel","refresh","level","REFLOW","__renderMode","mode","CANVAS","__defs","clear","isFirst","self","ctx","wrap","draw","createVd","tagName","children","indexOf","IMG","INIT","LOADING","LOADED","measureImg","url","optinos","root","width","height","img","createImage","onload","success","source","src","state","task","push","my","getImageInfo","res","canvas","list","splice","forEach","fail","isDom","o","arc","CANVAS_LIST","WEBGL_LIST","key","hash","message","target","length","pop","_createOffscreenCanvas","available","release","cacheCanvas","hasCacheCanvas","hasOwnProperty","getCacheCanvas","releaseCacheCanvas","delCacheCanvas","myVersion","version"],"mappings":"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"}