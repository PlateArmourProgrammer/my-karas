{"version":3,"file":"index.js","sources":["src/index.js"],"sourcesContent":["import karas from 'karas';\n\nkaras.inject.requestAnimationFrame = function(cb) {\n  setTimeout(cb, 1000 / 60);\n};\n\nclass Root extends karas.Root {\n  appendTo(ctx) {\n    this.__initProps();\n    this.__refreshLevel = karas.level.REFLOW;\n    this.__ctx = ctx;\n    this.__renderMode = karas.mode.CANVAS;\n    this.__defs = {\n      clear() {},\n    };\n    this.refresh();\n  }\n\n  refresh(cb) {\n    let ctx = this.ctx;\n\n    function wrap() {\n      ctx.draw(true);\n      cb && cb();\n    }\n\n    super.refresh(wrap);\n  }\n}\n\n// Root引用指过来\nlet createVd = karas.createVd;\nkaras.createVd = function(tagName, props, children) {\n  if(['canvas', 'svg'].indexOf(tagName) > -1) {\n    return new Root(tagName, props, children);\n  }\n  return createVd(tagName, props, children);\n};\n\nconst IMG = karas.inject.IMG;\nconst INIT = karas.inject.INIT;\nconst LOADING = karas.inject.LOADING;\nconst LOADED = karas.inject.LOADED;\n\nkaras.inject.measureImg = function(url, cb, optinos = {}) {\n  if(url.indexOf('data:') === 0) {\n    let { width = {}, height = {} } = optinos;\n    cb({\n      success: true,\n      width: width.value,\n      height: height.value,\n      url,\n      source: url,\n    });\n    return;\n  }\n  let cache = IMG[url] = IMG[url] || {\n    state: INIT,\n    task: [],\n  };\n  if(cache.state === LOADED) {\n    cb(cache);\n  }\n  else if(cache.state === LOADING) {\n    cache.task.push(cb);\n  }\n  else {\n    cache.state = LOADING;\n    cache.task.push(cb);\n    my.getImageInfo({\n      src: url,\n      success: function(res) {\n        cache.state = LOADED;\n        cache.success = true;\n        cache.width = res.width;\n        cache.height = res.height;\n        cache.source = url;\n        cache.url = url;\n        let list = cache.task.splice(0);\n        list.forEach(cb => cb(cache));\n      },\n      fail: function() {\n        cache.state = LOADED;\n        cache.success = false;\n        cache.url = url;\n        let list = cache.task.splice(0);\n        list.forEach(cb => cb(cache));\n      },\n    });\n  }\n};\n\nkaras.inject.isDom = function(o) {\n  return o && karas.util.isFunction(o.arc);\n}\n\nlet cc, mc;\n\nkaras.inject.setCacheCanvas = function(o) {\n  cc = o;\n};\n\nkaras.inject.setMaskCanvas = function(o) {\n  mc = o;\n};\n\nkaras.inject.getCacheCanvas = function() {\n  if(!cc) {\n    throw new Error('Need a cache canvas');\n  }\n  return {\n    ctx: cc,\n    canvas: cc,\n    draw(ctx) {\n      ctx.draw(true);\n    },\n  };\n};\n\nkaras.inject.getMaskCanvas = function() {\n  if(!mc) {\n    throw new Error('Need a mask canvas');\n  }\n  return {\n    ctx: mc,\n    canvas: mc,\n    draw(ctx) {\n      ctx.draw(true);\n    },\n  };\n};\n\nexport default karas;\n"],"names":["karas","inject","requestAnimationFrame","cb","setTimeout","Root","ctx","__initProps","__refreshLevel","level","REFLOW","__ctx","__renderMode","mode","CANVAS","__defs","clear","refresh","wrap","draw","createVd","tagName","props","children","indexOf","IMG","INIT","LOADING","LOADED","measureImg","url","optinos","width","height","success","value","source","cache","state","task","push","my","getImageInfo","src","res","list","splice","forEach","fail","isDom","o","util","isFunction","arc","cc","mc","setCacheCanvas","setMaskCanvas","getCacheCanvas","Error","canvas","getMaskCanvas"],"mappings":"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"}